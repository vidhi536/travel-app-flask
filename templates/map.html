<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlanNGo â€“ Route Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        
        /* Floating Info Card */
        .info-card {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 15px;
            width: 90%;
            max-width: 500px;
        }

        /* Bottom Action Bar */
        .action-bar {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4);
            transition: transform 0.2s;
        }

        .btn-primary:hover { transform: translateY(-2px); }
    </style>
</head>

<body>

    <div class="info-card">
        <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600">
            <i class="fa-solid fa-route"></i>
        </div>
        <div>
            <h3 class="font-bold text-slate-800 text-sm m-0">Optimized Route</h3>
            <p id="status-text" class="text-xs text-slate-500 m-0">Locating you...</p>
        </div>
    </div>

    <div id="map"></div>

    <div class="action-bar">
        <button class="btn-primary" onclick="window.location.href='/trip'">
            <i class="fa-solid fa-list-check mr-2"></i> View Full Itinerary
        </button>
    </div>

    <script>
let map;
let directionsService;
let directionsRenderer;
let placesService;

const params = new URLSearchParams(window.location.search);
const destinationQuery = params.get("destination") || "Gateway of India, Mumbai";

function initMap() {

    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: 18.5204, lng: 73.8567 },
        mapTypeControl: false,
        fullscreenControl: false
    });

    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true, // IMPORTANT: we will add custom markers
        polylineOptions: {
            strokeColor: "#4f46e5",
            strokeWeight: 6,
            strokeOpacity: 0.8
        }
    });

    placesService = new google.maps.places.PlacesService(map);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {

            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map.setCenter(userLocation);

            // USER MARKER
            new google.maps.Marker({
                position: userLocation,
                map: map,
                title: "You are here",
                icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });

            document.getElementById("status-text").innerText =
                "Found you! Calculating route...";

            findDestinationAndRoute(userLocation, destinationQuery);

        }, () => handleLocationError(true));
    } else {
        handleLocationError(false);
    }
}

// Convert Destination Name to Coordinates
function findDestinationAndRoute(startLoc, destName) {

    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: destName }, (results, status) => {

        if (status === "OK") {

            const destLocation = results[0].geometry.location;

            // DESTINATION MARKER
            new google.maps.Marker({
                position: destLocation,
                map: map,
                title: "Destination",
                icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
            });

            findNearbyAttractions(startLoc, destLocation);

        } else {
            alert("Destination not found.");
        }
    });
}

// Find Tourist Attractions Near Destination
function findNearbyAttractions(startLoc, destLocation) {

    const request = {
        location: destLocation,
        radius: 5000,
        type: ['tourist_attraction']
    };

    placesService.nearbySearch(request, (results, status) => {

        let waypoints = [];

        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {

            // Sort by rating (highest first)
            results.sort((a, b) => (b.rating || 0) - (a.rating || 0));

            const topPlaces = results.slice(0, 3);

            topPlaces.forEach((place) => {

                waypoints.push({
                    location: place.geometry.location,
                    stopover: true
                });

                new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name,
                    icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
                });
            });

            document.getElementById("status-text").innerText =
                `Route via ${topPlaces.length} famous spots`;
        }

        calculateRoute(startLoc, destLocation, waypoints);
    });
}

// Draw Route
function calculateRoute(start, end, waypoints) {

    const request = {
        origin: start,
        destination: end,
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING
    };

    directionsService.route(request, function(result, status) {

        if (status === "OK") {

            directionsRenderer.setDirections(result);

        } else {

            console.error("Directions failed with status:", status);
            alert("Directions failed: " + status);
        }
    });
}



function handleLocationError(browserHasGeolocation) {
    alert(browserHasGeolocation ?
        "Geolocation failed." :
        "Browser doesn't support geolocation.");
}
</script>


    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkIPEHU60BvEC3d598gpel5L9wT0lfai0&libraries=places&callback=initMap">
    </script>

</body>
</html>