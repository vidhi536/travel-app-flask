<!DOCTYPE html>
<html>
<head>
  <title>Tourist Places Around Me</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    button {
      padding: 10px 15px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>üìç Tourist Places Around You</h2>
<a href="/itinerary"><button onclick="goToItinerary()">View Planned Itinerary</button></a>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  let map;
  let placesData = [];

  // Initialize map
  map = L.map("map").setView([0, 0], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap contributors"
  }).addTo(map);

  // Get current location
  navigator.geolocation.getCurrentPosition(
    position => {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      map.setView([lat, lon], 14);

      // User marker
      L.marker([lat, lon])
        .addTo(map)
        .bindPopup("üìç You are here")
        .openPopup();

      fetchTouristPlaces(lat, lon);
    },
    error => {
      alert("Location access denied");
    }
  );

  // Fetch tourist places from OpenTripMap
  function fetchTouristPlaces(lat, lon) {
    const apiKey = "5ae2e3f221c38a28845f05b6abb8c85a315b1b89d4c85f706211f4b0";
    const radius = 5000; // 5 km

    const url = `https://api.opentripmap.com/0.1/en/places/radius?radius=${radius}&lon=${lon}&lat=${lat}&kinds=tourist_attraction&limit=10&apikey=${apiKey}`;

    fetch(url)
  .then(res => {
    if (!res.ok) {
      throw new Error("API failed: " + res.status);
    }
    return res.json();
  })
  .then(data => {
    if (!data.features || data.features.length === 0) {
      console.log("No places returned");
      return;
    }

    placesData = data.features;

    placesData.forEach(place => {
      const lat = place.geometry.coordinates[1];
      const lon = place.geometry.coordinates[0];
      const name = place.properties.name || "Tourist Place";

      L.marker([lat, lon]).addTo(map).bindPopup(name);
    });

    localStorage.setItem("itineraryPlaces", JSON.stringify(placesData));
    console.log("Saved places:", placesData.length);
  })
  .catch(err => console.error(err));
  }

  function goToItinerary() {
    window.location.href = "itinerary.html";
  }
</script>

</body>
</html>